# レポート表示更新の改善

## 問題

ユーザーから報告された問題:
「集計期間の情報が更新されません。もしかしたら、打刻実績がある為、うまく締め日設定を変更できないのか、あるいは１５日締めの設定が打刻システム上不可能になっている可能性もあるかと思います。」

## 原因の調査

### バックエンドロジックの確認

[test_closing_day.py](test_closing_day.py) と [test_gui_report_refresh.py](test_gui_report_refresh.py) を作成してテストした結果:

**結果**: バックエンドロジックは正常に動作している

```
月末締め (31日) → 集計期間: 2025-10-01 ～ 2025-10-31
15日締め (15日) → 集計期間: 2025-09-16 ～ 2025-11-15
月末締め (31日) → 集計期間: 2025-10-01 ～ 2025-10-31
```

- 締め日設定は正しくJSONに保存される
- `get_monthly_summary()` は正しい締め日設定を読み込む
- 集計期間の計算ロジックは正しく動作する

### 真の原因

**レポート表示は自動更新されない**

GUIの動作:
1. ユーザーが「レポート表示」ボタンを押す
2. その時点の設定でレポートを生成して表示
3. 設定を変更しても、表示中のレポートは自動更新されない

つまり:
- 設定タブで締め日を変更して保存
- レポートタブに戻る
- **以前に表示したレポートがそのまま残っている**
- 「レポート表示」ボタンを再度押さないと更新されない

## 解決策

### 実装した改善

[gui.py](gui.py) の `save_user_config()` メソッドに以下の機能を追加:

#### 1. ユーザーへの通知

```python
messagebox.showinfo("設定保存",
    f"{username} の設定を保存しました\n\n"
    f"【保存した内容】\n"
    f"締め日: {saved_config['closing_day']}日 ({closing_day_text})\n"
    f"標準労働時間: {saved_config['standard_hours_per_day']}時間/日\n\n"
    f"※ レポート画面で月次レポートを表示している場合は、\n"
    f"  「レポート表示」ボタンを再度押すと更新されます。")
```

#### 2. 自動更新機能

設定保存時に以下の条件をチェック:
- レポートタブで月次レポートを表示中
- 表示中のアカウントが設定を変更したアカウントと同じ
- レポートが既に表示されている

条件を満たす場合、`show_report()` を自動呼び出しして更新:

```python
# レポートタブで月次レポートを表示中の場合、自動更新を提案
if (self.report_type_var.get() == "monthly" and
    self.report_account_var.get() == username and
    self.report_text.get(1.0, tk.END).strip()):
    # レポートが表示されているので自動更新
    self.show_report()
```

## 使用方法

### 以前の動作

1. 設定タブで締め日を変更
2. 「設定を保存」ボタンをクリック
3. レポートタブに移動
4. **手動で「レポート表示」ボタンを再度クリックする必要があった**

### 改善後の動作

1. 設定タブで締め日を変更
2. 「設定を保存」ボタンをクリック
3. レポートタブで既に月次レポートを表示中の場合 → **自動的に更新される**
4. レポートタブで表示していない場合 → メッセージで更新方法を案内

## 確認方法

### テストシナリオ1: 自動更新

1. GUIを起動
2. レポートタブで月次レポートを表示 (例: テストユーザー、2025-10)
3. 設定タブに移動
4. 同じユーザー (テストユーザー) の締め日を変更 (31 → 15)
5. 「設定を保存」ボタンをクリック
6. レポートタブに戻る
7. **集計期間が自動的に更新されている**

### テストシナリオ2: 手動更新

1. GUIを起動
2. 設定タブで締め日を変更
3. 「設定を保存」ボタンをクリック
4. レポートタブに移動
5. 「レポート表示」ボタンをクリック
6. 新しい締め日設定で集計期間が表示される

## 技術的詳細

### 締め日計算ロジック ([timeclock.py:299-352](timeclock.py#L299-L352))

#### 月末締め (closing_day = 31)

```python
# 例: 2025年10月
start_date = "2025-10-01"
end_date = "2025-10-31"
```

#### 15日締め (closing_day = 15)

```python
# 例: 2025年10月 → 前月16日～当月15日
start_date = "2025-09-16"  # 前月16日
end_date = "2025-11-15"    # 翌月15日
```

### レポート生成の流れ

1. `show_report()` が呼ばれる ([gui.py:628](gui.py#L628))
2. `tc.get_monthly_summary(account, year, month)` を呼び出し ([gui.py:652](gui.py#L652))
3. `get_monthly_summary()` 内で設定を読み込み ([timeclock.py:315](timeclock.py#L315))
   ```python
   account_config = self.storage.get_account_config(account)
   closing_day = account_config['closing_day']
   ```
4. 締め日に基づいて集計期間を計算 ([timeclock.py:322-352](timeclock.py#L322-L352))
5. 結果をフォーマットして表示 ([gui.py:683](gui.py#L683))

## まとめ

- **バックエンドロジック**: 正常に動作
- **15日締め設定**: 完全に対応、問題なし
- **打刻実績の影響**: なし (設定変更は常に可能)
- **問題の本質**: レポート表示の自動更新機能の不足
- **解決策**: 自動更新機能の追加 + ユーザーへの案内メッセージ

## 関連ファイル

- [gui.py](gui.py) - GUI実装、自動更新機能追加
- [timeclock.py](timeclock.py) - 締め日計算ロジック
- [storage.py](storage.py) - 設定の保存・読み込み
- [test_closing_day.py](test_closing_day.py) - 締め日設定のテスト
- [test_gui_report_refresh.py](test_gui_report_refresh.py) - レポート更新のテスト
